version: "3.8"

networks:
  signoz-net:
    name: signoz-net
    external: false

services:
  postgres:
    image: postgres:16-alpine
    container_name: aurea_postgres
    networks: [signoz-net]
    ports:
      - "127.0.0.1:5432:5432" # Solo tú vía SSH
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: aurea_redis
    networks: [signoz-net]
    ports:
      - "127.0.0.1:6379:6379" # Solo tú vía SSH
    deploy:
      resources:
        limits:
          memory: 256mb

  clickhouse:
    image: clickhouse/clickhouse-server:25.5.6
    container_name: signoz-clickhouse
    networks: [signoz-net]
    environment:
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    ports:
      - "127.0.0.1:8123:8123" # Puerto HTTP de ClickHouse (solo SSH)
      - "127.0.0.1:9000:9000" # Puerto nativo de ClickHouse (solo SSH)
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./cluster.xml:/etc/clickhouse-server/config.d/cluster.xml
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "--user=${CLICKHOUSE_USER}", "--password=${CLICKHOUSE_PASSWORD}", "localhost:8123/ping"]

  signoz:
    image: signoz/signoz:v0.110.1
    container_name: signoz-query-service
    networks: [signoz-net]
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - SIGNOZ_TELEMETRYSTORE_CLICKHOUSE_DSN=tcp://${CLICKHOUSE_USER}:${CLICKHOUSE_PASSWORD}@clickhouse:9000
      - STORAGE=clickhouse
    # IMPORTANTE: No mapeamos puerto aquí. Usaremos la pestaña "Domains" en Coolify para acceder vía HTTPS.
    volumes:
      - signoz_sqlite:/var/lib/signoz

  otel-collector:
    image: signoz/signoz-otel-collector:v0.129.13
    container_name: signoz-otel-collector
    networks: [signoz-net]
    command: ["--config=/etc/otel-collector-config.yaml"]
    ports:
      - "127.0.0.1:4317:4317" # Para enviar telemetría desde fuera si fuera necesario vía SSH
      - "127.0.0.1:4318:4318"
    environment:
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml

  # Zookeeper y Migrator se quedan sin puertos (son 100% internos)
  zookeeper:
    image: signoz/zookeeper:3.7.1
    container_name: signoz-zookeeper-1
    networks: [signoz-net]
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes

schema-migrator-sync:
    image: 'signoz/signoz-schema-migrator:v0.129.13'
    container_name: schema-migrator-sync
    networks:
      - signoz-net
    restart: "no"
    # Cambiamos el entrypoint para debuguear y forzar salida limpia
    entrypoint: ["sh", "-c"]
    command: 
      - |
        echo "Esperando a ClickHouse..."
        sleep 10
        ./signoz-schema-migrator sync --dsn=tcp://${CLICKHOUSE_USER}:${CLICKHOUSE_PASSWORD}@clickhouse:9000/ --cluster-name=cluster --replication=true || echo "Fallo en migración, pero continuando..."
        exit 0
    depends_on:
      clickhouse:
        condition: service_healthy
  
volumes:
  postgres_data:
  clickhouse_data:
    name: signoz-clickhouse
  signoz_sqlite:
    name: signoz-sqlite