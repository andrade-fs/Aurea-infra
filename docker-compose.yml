version: "3.8"

networks:
  signoz-net:
    name: signoz-net
    external: false

services:
  # --- BASES DE DATOS (Privadas) ---
  postgres:
    image: postgres:16-alpine
    container_name: aurea_postgres
    networks: [signoz-net]
    # Puertos eliminados para seguridad. Acceso interno: postgres:5432
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 1g

  redis:
    image: redis:7-alpine
    container_name: aurea_redis
    networks: [signoz-net]
    deploy:
      resources:
        limits:
          memory: 256mb

  # --- INFRAESTRUCTURA SIGNOZ ---
  zookeeper:
    image: signoz/zookeeper:3.7.1
    container_name: signoz-zookeeper-1
    networks: [signoz-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8080/commands/ruok | grep null"]
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes

  clickhouse:
    image: clickhouse/clickhouse-server:25.5.6
    container_name: signoz-clickhouse
    networks: [signoz-net]
    environment:
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./cluster.xml:/etc/clickhouse-server/config.d/cluster.xml
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "--user=${CLICKHOUSE_USER}", "--password=${CLICKHOUSE_PASSWORD}", "localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  signoz:
    image: signoz/signoz:v0.110.1
    container_name: signoz-query-service
    networks: [signoz-net]
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - SIGNOZ_TELEMETRYSTORE_CLICKHOUSE_DSN=tcp://${CLICKHOUSE_USER}:${CLICKHOUSE_PASSWORD}@clickhouse:9000
      - SIGNOZ_SQLSTORE_SQLITE_PATH=/var/lib/signoz/signoz.db
      - STORAGE=clickhouse
    # Nota: Si quieres ver el panel de SigNoz, as√≠gnale un Dominio en la UI de Coolify apuntando al puerto 8080
    volumes:
      - signoz_sqlite:/var/lib/signoz
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8080/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  schema-migrator-sync:
    image: signoz/signoz-schema-migrator:v0.129.13
    container_name: schema-migrator-sync
    networks: [signoz-net]
    restart: "no"
    command:
      - sync
      - --dsn=tcp://${CLICKHOUSE_USER}:${CLICKHOUSE_PASSWORD}@clickhouse:9000/
      - --cluster-name=cluster
      - --replication=true
    depends_on:
      clickhouse:
        condition: service_healthy

  otel-collector:
    image: signoz/signoz-otel-collector:v0.129.13
    container_name: signoz-otel-collector
    networks: [signoz-net]
    command: ["--config=/etc/otel-collector-config.yaml"]
    environment:
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    depends_on:
      schema-migrator-sync:
        condition: service_completed_successfully
      signoz:
        condition: service_healthy

volumes:
  postgres_data:
  clickhouse_data:
    name: signoz-clickhouse
  signoz_sqlite:
    name: signoz-sqlite